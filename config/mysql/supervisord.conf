[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
user=root
childlogdir=/var/log/supervisor

; Include additional config files
[include]
files = /etc/supervisor/conf.d/*.conf

; MySQL database service
[program:mysql]
command=mysqld
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/mysql.log
stderr_logfile=/var/log/mysql_err.log
startretries=5
startsecs=10
stopwaitsecs=120
; Add a simple health check script that supervisord will use to check if MySQL is ready
; This helps with dependency management
stdout_events_enabled=true
stderr_events_enabled=true

; Database initialization - runs once and exits
[program:db-init]
command=/bin/bash -c "sleep 15 && /home/%(ENV_USER_NAME)s/2009scape/config/mysql/01-initialize-database.sh"
autostart=true
autorestart=false
startsecs=0
startretries=3
priority=20
environment=MYSQL_USER="%(ENV_MYSQL_USER)s",MYSQL_PASSWORD="%(ENV_MYSQL_PASSWORD)s",MYSQL_DATABASE="%(ENV_MYSQL_DATABASE)s"
stdout_logfile=/var/log/db-init.log
stderr_logfile=/var/log/db-init_err.log
; Using exitcodes to mark successful completion
exitcodes=0
; Use sleep to ensure MySQL is fully initialized before running this

; 2009scape game server
[program:2009scape-server]
command=/bin/bash -c "sleep 5 && /home/%(ENV_USER_NAME)s/2009scape/server/server.sh"
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/2009scape-server.log
stderr_logfile=/var/log/2009scape-server_err.log
environment=MYSQL_HOST="%(ENV_MYSQL_HOST)s",MYSQL_USER="%(ENV_MYSQL_USER)s",MYSQL_PASSWORD="%(ENV_MYSQL_PASSWORD)s",MYSQL_DATABASE="%(ENV_MYSQL_DATABASE)s",JAVA_OPTS="%(ENV_JAVA_OPTS)s"
startretries=5
stopasgroup=true
killasgroup=true
; Using sleep to ensure database init is complete

; 2009scape management interface
[program:2009scape-management]
command=/bin/bash -c "sleep 30 && /home/%(ENV_USER_NAME)s/2009scape/management/management.sh"
autostart=true
autorestart=true
priority=40
stdout_logfile=/var/log/2009scape-management.log
stderr_logfile=/var/log/2009scape-management_err.log
environment=MYSQL_HOST="%(ENV_MYSQL_HOST)s",MYSQL_USER="%(ENV_MYSQL_USER)s",MYSQL_PASSWORD="%(ENV_MYSQL_PASSWORD)s",MYSQL_DATABASE="%(ENV_MYSQL_DATABASE)s",JAVA_OPTS="%(ENV_JAVA_OPTS)s"
startretries=3
stopasgroup=true
killasgroup=true
; Using sleep to ensure server is running before starting management

; Event listeners for managing dependencies
[eventlistener:mysql_ready]
command=echo READY
events=PROCESS_STATE_RUNNING
buffer_size=100

; Group all 2009scape services
[group:2009scape]
programs=mysql,db-init,2009scape-server,2009scape-management
priority=999